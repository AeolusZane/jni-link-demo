#!/usr/bin/env node
// è¿™ä¸ªjsç”¨æ¥æ‰§è¡Œæ­¥éª¤
import shell from 'shelljs';
import figlet from 'figlet';

const versionStr = figlet.textSync('Aeolus-Jzane');
import { program } from 'commander';
import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
const java_home = shell.exec('echo $JAVA_HOME', { silent: true }).stdout.trim();
// 1. æ‰§è¡Œå‘½ä»¤

program.version(versionStr, '-v, --version', 'æŸ¥çœ‹ç‰ˆæœ¬å·');

program.option('d', 'æ¸…ç†libã€java jniæ–‡ä»¶');

program.option('step1', 'ç”Ÿæˆå¤´æ–‡ä»¶[JT.class]');
program.option('step2', 'ç”Ÿæˆjavaå­—èŠ‚ç æ–‡ä»¶[JT.h]');
program.option('step3', 'ç”Ÿæˆé™æ€é“¾æ¥åº“libwelcome.a');
program.option('step4', 'ç¼–è¯‘å®ç°jniæ–¹æ³•çš„demo.c');
program.option('step5', 'é“¾æ¥é™æ€é“¾æ¥åº“ï¼ˆç”Ÿæˆlib.soæ–‡ä»¶ç»™javaçš„jniè°ƒç”¨ä½¿ç”¨ï¼‰');
program.option('step6', 'æ‰§è¡Œjavaä»£ç ');

const bindHandler = {
    d() {
        const spinner = ora('æ­£åœ¨æ¸…ç†libæ–‡ä»¶').start();
        shell.rm('-rf', './lib/*');
        spinner.succeed('æ¸…ç†å®Œæˆ');
        const spinner1 = ora('æ­£åœ¨æ¸…ç†java jniæ–‡ä»¶').start();
        shell.rm('-rf', './JT.h');
        shell.rm('-rf', './JT.class');
        spinner1.succeed('æ¸…ç†å®Œæˆ');
    },
    step1() {
        const spinner = ora('æ­£åœ¨ç”Ÿæˆå¤´æ–‡ä»¶[JT.class]').start();
        shell.exec('javac JT.java');
        spinner.succeed('ç”Ÿæˆå®Œæˆ');
    },
    step2() {
        const spinner = ora('æ­£åœ¨ç”Ÿæˆjavaå­—èŠ‚ç æ–‡ä»¶[JT.h]').start();
        shell.exec('javah JT');
        spinner.succeed('ç”Ÿæˆå®Œæˆ');
    },
    step3() {
        const spinner = ora('æ­£åœ¨ç”Ÿæˆé™æ€é“¾æ¥åº“libwelcome.a').start();
        shell.exec('gcc -Wall -O2 -fPIC -I./  -c -o ./lib/welcome.o welcome.c');
        shell.exec('ar crv ./lib/libwelcome.a ./lib/welcome.o');
        spinner.succeed('ç”Ÿæˆå®Œæˆ');
    },
    async step4() {
        const spinner = ora('æ­£åœ¨ç¼–è¯‘å®ç°jniæ–¹æ³•çš„demo.c').start();
        const cmd = `gcc -Wall -O2 -fPIC -I ${java_home}/include/ -I ${java_home}/include/darwin/ -I./  -c -o ./lib/demo.o demo.c`;
        shell.exec(cmd);
        spinner.succeed('ç”Ÿæˆå®Œæˆ');
    },
    step5() {
        const spinner = ora('æ­£åœ¨é“¾æ¥é™æ€é“¾æ¥åº“ï¼ˆç”Ÿæˆlib.soæ–‡ä»¶ç»™javaçš„jniè°ƒç”¨ä½¿ç”¨ï¼‰').start();
        shell.exec('gcc -shared ./lib/demo.o -L./lib -lwelcome -o ./lib/libdemo.so');
        spinner.succeed('ç”Ÿæˆå®Œæˆ');
    },
    step6() {
        const spinner = ora('æ­£åœ¨æ‰§è¡Œjavaä»£ç ').start();
        shell.exec('java -Djava.library.path=./ JT');
        spinner.succeed('æ‰§è¡Œå®Œæˆ');
    }

}

program.usage('<cmd> [env]')
    .arguments('<cmd> [env]')
    .action(function (cmd, otherParams) {
        const handler = bindHandler[cmd];
        if (handler) {
            handler(otherParams);
        } else {
            // console.log('æ²¡æœ‰è¯¥å‘½ä»¤å“¦ğŸ·');
            console.log(chalk.yellow('æ²¡æœ‰å‘½ä»¤ã€' + chalk.red(cmd) + 'ã€‘å“¦ğŸ·'))
        }
    })
program.parse(process.argv)


